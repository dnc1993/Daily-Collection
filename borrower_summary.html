<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Borrower Loan Summary</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f6f8; }
nav { background-color: #2c3e50; padding: 12px 20px; text-align: center; }
nav a { color: #ecf0f1; margin: 0 15px; text-decoration: none; font-weight: bold; font-size: 16px; }
nav a:hover { color: #f39c12; text-decoration: underline; }
h1 { text-align: center; margin-top: 25px; color: #34495e; }
.section { max-width: 1200px; margin: 30px auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
.section h2 { text-align: center; margin-bottom: 15px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #ddd; }
th { background-color: #3498db; color: white; }
tbody tr:nth-child(even) { background-color: #f9f9f9; }
tbody tr:hover { background-color: #ecf0f1; transition: 0.3s; }
.week-box { padding: 5px; border-radius: 5px; margin: 2px; display: inline-block; color: white; }
.paid { background-color: #2ecc71; }
.unpaid { background-color: #e74c3c; }
.overdue { background-color: #e67e22; font-weight: bold; }
.highlighted { background-color: #f39c12 !important; border: 2px solid #e67e22; animation: pulse 1s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
button:disabled { opacity: 0.6; cursor: not-allowed; }
button.processing { background-color: #f39c12; }
button.processing::after { content: " Processing..."; }
input, button { padding: 8px; font-size: 16px; margin-top: 5px; }
button { cursor: pointer; background-color: #3498db; color: white; border: none; border-radius: 5px; }
button:hover { background-color: #2980b9; }
.summary-totals { display: flex; justify-content: space-between; flex-wrap: wrap; margin-top: 20px; padding: 15px; background-color: #ecf0f1; border-radius: 8px; }
.summary-totals div { flex: 1 1 200px; margin: 5px; padding: 10px; background-color: #fff; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; }
.summary-totals div h3 { margin: 5px 0; font-size: 1em; color: #2c3e50; }
.summary-totals div p { margin: 0; font-size: 1.1em; font-weight: bold; color: #34495e; }
</style>
</head>
<body>
<nav>
  
</nav>

<h1>Borrower Loan Summary</h1>

<div class="section">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
    <div>
      <label>Enter Borrower ID:</label>
      <input type="text" id="borrower-id-input" style="margin-left: 10px;">
      <button onclick="loadBorrowerSummary()">Search</button>
    </div>
    <div id="filter-section" style="display: none;">
      <label>Filter:</label>
      <select id="loan-filter" onchange="loadBorrowerSummary()" style="margin-left: 10px; padding: 8px;">
        <option value="outstanding">Outstanding Loans</option>
        <option value="all">All Loans</option>
        <option value="completed">Completed Loans</option>
      </select>
    </div>
  </div>
</div>

<div class="section" id="installments-search-section" style="display: none;">
  <h2>Installments Due Search</h2>
  <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
    <div>
      <label>Select Date:</label>
      <input type="date" id="future-date-input" style="margin-left: 10px;">
    </div>
    <button id="show-installments-btn" onclick="showInstallmentsDue()" style="background-color: #27ae60;">Show Installments Due</button>
  </div>
  <div id="installments-due-container" style="margin-top: 20px;"></div>
</div>

<div class="section" id="summary-container"></div>

<script>
const API_URL = "";

function formatLKR(amount){
    return "LKR " + parseFloat(amount).toLocaleString("si-LK", {minimumFractionDigits:2, maximumFractionDigits:2});
}

async function loadBorrowerSummary(){
    const borrowerId = document.getElementById("borrower-id-input").value.trim();
    const filterType = document.getElementById("loan-filter").value;

    if(!borrowerId){
        alert("Enter Borrower ID");
        return;
    }

    // Show the filter and installments search sections when borrower ID is entered
    document.getElementById("filter-section").style.display = "block";
    document.getElementById("installments-search-section").style.display = "block";

    // Clear previous search results and highlights
    window.lastSearchResults = null;
    document.querySelectorAll('.highlighted').forEach(el => {
        el.classList.remove('highlighted');
    });

    const loansRes = await fetch(`${API_URL}/api/loans`);
    const loans = await loansRes.json();
    const paymentsRes = await fetch(`${API_URL}/api/payments`);
    const payments = await paymentsRes.json();

    let borrowerLoans = loans.filter(l => l.borrower_id == borrowerId);

    // Sort loans by start date (latest first) - applied before filtering
    borrowerLoans.sort((a, b) => new Date(b.start_date) - new Date(a.start_date));

    // Apply filter
    if(filterType === "completed"){
        borrowerLoans = borrowerLoans.filter(loan => {
            const paidWeeks = payments.filter(p => p.loan_id === loan.id).length;
            return paidWeeks >= loan.weeks;
        });
    } else if(filterType === "outstanding"){
        borrowerLoans = borrowerLoans.filter(loan => {
            const paidWeeks = payments.filter(p => p.loan_id === loan.id).length;
            return paidWeeks < loan.weeks;
        });
    }

    // Sort loans by start date (latest first) - applied after filtering to maintain order
    borrowerLoans.sort((a, b) => new Date(b.start_date) - new Date(a.start_date));

    const container = document.getElementById("summary-container");
    container.innerHTML = "";

    if(borrowerLoans.length === 0){
        const filterText = filterType === "all" ? "" : ` with filter "${filterType}"`;
        container.innerHTML = `<p>No loans found for this borrower${filterText}.</p>`;
        return;
    }

    let totalPrincipal = 0;
    let totalInterest = 0;
    let totalPaidAll = 0;
    let totalOutstanding = 0;

    borrowerLoans.forEach((loan,index)=>{
        const loanDiv = document.createElement("div");
        loanDiv.setAttribute('data-loan-id', loan.id);
        loanDiv.style.marginBottom = "25px";
        loanDiv.style.border = "1px solid #ddd";
        loanDiv.style.borderRadius = "8px";
        loanDiv.style.padding = "15px";

        const loanHeader = document.createElement("h3");
        const paidWeeks = payments.filter(p => p.loan_id === loan.id).length;
        const isCompleted = paidWeeks >= loan.weeks;
        const statusColor = isCompleted ? "#27ae60" : "#f39c12";

        loanHeader.innerHTML = `<span style="color: #e74c3c;">L.ID: ${loan.id}</span> | <span style="color: #3498db;">B.N: ${loan.borrower}</span> | B.ID: ${loan.borrower_id} | <span style="color: ${statusColor};">${isCompleted ? 'COMPLETED' : 'IN PROGRESS'}</span>`;
        loanDiv.appendChild(loanHeader);

        const weeklyInstallment = (loan.amount*(1+loan.interest/100)/loan.weeks).toFixed(2);
        const principal = loan.amount;
        const interestAmount = loan.amount*loan.interest/100;
        const interestPercentage = ((interestAmount/principal)*100).toFixed(2);
        totalPrincipal += principal;
        totalInterest += interestAmount;
        const originalAmount = principal + interestAmount;

        let tableHTML = `<table>
        <thead>
        <tr>
            <th>Week</th>
            <th>Status</th>
            <th>Amount</th>
            <th>Due Date</th>
        </tr>
        </thead>
        <tbody>`;

        // Parse date string explicitly to avoid timezone issues
        const dateParts = loan.start_date.split('-');
        const startDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Set to start of today

        for(let i=1;i<=loan.weeks;i++){
            const paidRecord = payments.find(p => p.loan_id === loan.id && p.week === i);
            const dueDate = new Date(startDate);
            dueDate.setDate(dueDate.getDate() + 7*i);
            dueDate.setHours(0, 0, 0, 0); // Set to start of due date

            // Check if payment exists for this week (regardless of exact date)
            const hasPaymentForWeek = payments.some(p => p.loan_id === loan.id && p.week === i);
            const isOverdue = !hasPaymentForWeek && dueDate < today;
            const statusClass = hasPaymentForWeek ? 'paid' : (isOverdue ? 'overdue' : 'unpaid');
            const statusText = hasPaymentForWeek ? 'Paid' : (isOverdue ? 'Overdue' : 'Unpaid');

            tableHTML += `<tr>
                <td>${i}</td>
                <td class="${statusClass}">${statusText}</td>
                <td>${formatLKR(weeklyInstallment)}</td>
                <td>${dueDate.toLocaleDateString("si-LK")}</td>
            </tr>`;
        }

        tableHTML += "</tbody></table>";

        const paidAmount = payments.filter(p => p.loan_id===loan.id).reduce((sum,p)=>sum+p.amount,0);
        totalPaidAll += paidAmount;
        const remaining = originalAmount - paidAmount;
        totalOutstanding += remaining;

        const summaryDiv = document.createElement("div");
        summaryDiv.style.display = "flex";
        summaryDiv.style.justifyContent = "space-between";
        summaryDiv.style.flexWrap = "wrap";
        summaryDiv.style.marginTop = "10px";
        summaryDiv.style.padding = "10px";
        summaryDiv.style.backgroundColor = "#f8f9fa";
        summaryDiv.style.borderRadius = "5px";

        summaryDiv.innerHTML = `
            <div><strong>Principal:</strong> ${formatLKR(principal)}</div>
            <div><strong>Interest:</strong> ${formatLKR(interestAmount)} (${interestPercentage}%)</div>
            <div><strong>Paid:</strong> ${formatLKR(paidAmount)}</div>
            <div><strong>Remaining:</strong> ${formatLKR(remaining)}</div>
        `;

        loanDiv.innerHTML += tableHTML;
        loanDiv.appendChild(summaryDiv);
        container.appendChild(loanDiv);
    });

    const totalsHTML = `
    <div class="summary-totals">
      <div><h3>Total Principal</h3><p>${formatLKR(totalPrincipal)}</p></div>
      <div><h3>Total Interest</h3><p>${formatLKR(totalInterest)}</p></div>
      <div><h3>Total Paid</h3><p>${formatLKR(totalPaidAll)}</p></div>
      <div><h3>Total Outstanding</h3><p>${formatLKR(totalOutstanding)}</p></div>
    </div>`;
    container.innerHTML += totalsHTML;
}

async function showInstallmentsDue(){
    try {
        const borrowerId = document.getElementById("borrower-id-input").value.trim();
        const futureDateStr = document.getElementById("future-date-input").value;
        const button = document.getElementById("show-installments-btn");

        console.log("Show Installments Due called with:", { borrowerId, futureDateStr });

        if(!borrowerId){
            alert("Enter Borrower ID first");
            return;
        }

        if(!futureDateStr){
            alert("Select a date");
            return;
        }

        // Show loading state
        button.disabled = true;
        button.classList.add('processing');
        button.textContent = 'Processing...';

        const futureDate = new Date(futureDateStr);
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Set to start of today
        futureDate.setHours(23, 59, 59, 999); // Set to end of selected date

        if(futureDate < today){
            alert("Please select today or a future date");
            // Reset button state
            button.disabled = false;
            button.classList.remove('processing');
            button.textContent = 'Show Installments Due';
            return;
        }

    const loansRes = await fetch(`${API_URL}/api/loans`);
    const loans = await loansRes.json();
    const paymentsRes = await fetch(`${API_URL}/api/payments`);
    const payments = await paymentsRes.json();

    // More robust filtering with case-insensitive and trimmed comparison
    const borrowerLoans = loans.filter(l => {
        return l.borrower_id && l.borrower_id.toString().trim() === borrowerId.toString().trim();
    });

    const container = document.getElementById("installments-due-container");
    container.innerHTML = "";

    // Debug: Show filtering results
    console.log("Borrower ID entered:", borrowerId);
    console.log("Total loans in database:", loans.length);
    console.log("Loans found for borrower:", borrowerLoans.length);
    console.log("Borrower loans:", borrowerLoans);

    if(borrowerLoans.length === 0){
        container.innerHTML = `<p>No loans found for borrower ID "${borrowerId}". Please check the ID and try again.</p>`;
        return;
    }

    let totalDue = 0;
    let installmentsData = [];

    // Create payment lookup map for better performance
    const paymentMap = new Map();
    payments.forEach(p => {
        if (!paymentMap.has(p.loan_id)) {
            paymentMap.set(p.loan_id, new Set());
        }
        paymentMap.get(p.loan_id).add(p.week);
    });

    borrowerLoans.forEach(loan => {
        const weeklyInstallment = (loan.amount*(1+loan.interest/100)/loan.weeks);
        // Parse date string explicitly to avoid timezone issues
        const dateParts = loan.start_date.split('-');
        const startDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
        const loanPayments = paymentMap.get(loan.id) || new Set();
        const paidWeeks = loanPayments.size;
        const todayStart = new Date(today);
        todayStart.setHours(0, 0, 0, 0);

        for(let week = paidWeeks + 1; week <= loan.weeks; week++){
            const dueDate = new Date(startDate);
            dueDate.setDate(dueDate.getDate() + 7 * week);

            if(dueDate <= futureDate){
                // Use the payment map for faster lookup
                const hasPaymentForWeek = loanPayments.has(week);
                const dueDateStart = new Date(dueDate);
                dueDateStart.setHours(0, 0, 0, 0);

                const isOverdue = !hasPaymentForWeek && dueDateStart < todayStart;
                installmentsData.push({
                    loanId: loan.id,
                    borrowerId: loan.borrower_id,
                    borrower: loan.borrower,
                    week: week,
                    amount: weeklyInstallment,
                    dueDate: dueDate,
                    isOverdue: isOverdue,
                    paidWeeks: paidWeeks,
                    totalWeeks: loan.weeks
                });
                totalDue += weeklyInstallment;
            }
        }
    });

    // Double-check that all installments belong to the requested borrower
    const filteredInstallments = installmentsData.filter(item => item.borrowerId == borrowerId);

    console.log("Total installments found:", installmentsData.length);
    console.log("Filtered installments for borrower:", filteredInstallments.length);

    if(filteredInstallments.length === 0){
        container.innerHTML = `<p>No installments due up to the selected date for borrower ID "${borrowerId}".</p>`;
        // Reset button state
        button.disabled = false;
        button.classList.remove('processing');
        button.textContent = 'Show Installments Due';
        return;
    }

    // Store search results for highlighting
    window.lastSearchResults = {
        borrowerId: borrowerId,
        futureDate: futureDate,
        installments: filteredInstallments
    };

    // Sort by due date
    filteredInstallments.sort((a, b) => a.dueDate - b.dueDate);

    let tableHTML = `
    <h3>Installments Due Up To ${futureDate.toLocaleDateString('en-US')}</h3>
    <table>
    <thead>
    <tr>
        <th>Loan ID</th>
        <th>Borrower</th>
        <th>Week</th>
        <th>Amount</th>
        <th>Due Date</th>
        <th>Status</th>
        <th>Progress</th>
    </tr>
    </thead>
    <tbody>`;

    filteredInstallments.forEach(item => {
        const statusClass = item.isOverdue ? 'overdue' : 'unpaid';
        const statusText = item.isOverdue ? 'OVERDUE' : 'Due';
        const progressText = `${item.paidWeeks}/${item.totalWeeks} weeks paid`;

        tableHTML += `<tr>
            <td>${item.loanId}</td>
            <td>${item.borrower}</td>
            <td>${item.week}</td>
            <td>${formatLKR(item.amount.toFixed(2))}</td>
            <td>${item.dueDate.toLocaleDateString("si-LK")}</td>
            <td class="${statusClass}">${statusText}</td>
            <td>${progressText}</td>
        </tr>`;
    });

    // Update total calculation with filtered data
    const finalTotalDue = filteredInstallments.reduce((sum, item) => sum + item.amount, 0);

    tableHTML += "</tbody></table>";
    tableHTML += `<div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px; text-align: center;">
        <h3 style="color: #27ae60; margin: 0;">Total Amount Due: ${formatLKR(finalTotalDue.toFixed(2))}</h3>
        <p style="margin: 5px 0 0 0; color: #666;">${filteredInstallments.length} installments due</p>
    </div>`;

    container.innerHTML = tableHTML;

    // Highlight matching installments in loan tables
    highlightMatchingInstallments();

    // Reset button state
    button.disabled = false;
    button.classList.remove('processing');
    button.textContent = 'Show Installments Due';

    } catch (error) {
        console.error("Error in showInstallmentsDue:", error);
        container.innerHTML = `<p style="color: red;">Error loading installments: ${error.message}</p>`;

        // Reset button state on error
        const button = document.getElementById("show-installments-btn");
        if(button) {
            button.disabled = false;
            button.classList.remove('processing');
            button.textContent = 'Show Installments Due';
        }
    }
}

// Highlight matching installments in loan tables
function highlightMatchingInstallments() {
    if (!window.lastSearchResults) return;

    const { installments } = window.lastSearchResults;

    // Remove existing highlights
    document.querySelectorAll('.highlighted').forEach(el => {
        el.classList.remove('highlighted');
    });

    // Highlight matching weeks in loan tables
    installments.forEach(installment => {
        const loanDiv = document.querySelector(`#summary-container div[data-loan-id="${installment.loanId}"]`);
        if (loanDiv) {
            const loanRows = loanDiv.querySelectorAll('table tbody tr');
            loanRows.forEach(row => {
                const weekCell = row.cells[0];
                if (weekCell && weekCell.textContent == installment.week) {
                    row.classList.add('highlighted');
                }
            });
        }
    });
}
</script>
</body>
</html>
