<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Loan App - Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f6f8; }
  nav { background-color: #2c3e50; padding: 12px 20px; text-align: center; }
  nav a { color: #ecf0f1; margin: 0 15px; text-decoration: none; font-weight: bold; font-size: 16px; }
  nav a:hover { text-decoration: underline; color: #f39c12; }

  h1 { text-align: center; margin-top: 25px; color: #34495e; }

  .dashboard-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; margin: 20px; }
  .dashboard-card { flex: 1 1 250px; text-align: center; padding: 20px; border-radius: 10px; background: linear-gradient(135deg, #3498db, #2980b9); color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
  .dashboard-card h2 { margin-bottom: 10px; }
  .dashboard-card p { font-size: 1.3em; font-weight: bold; }

  .section { max-width: 1000px; margin: 30px auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
  .section h2 { color: #2c3e50; margin-bottom: 15px; text-align: center; }

  .section { max-width: 1000px; margin: 30px auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #ddd; }
  th { background-color: #3498db; color: white; }
  tbody tr:nth-child(even) { background-color: #f9f9f9; }
  tbody tr:hover { background-color: #ecf0f1; transition: 0.3s; }

  button { padding: 5px 10px; background-color: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; }
  button:hover { background-color: #c0392b; }
</style>
</head>
<body>
<nav>
   <a href="/">Home</a>
   <a href="/newloan.html">New Loan</a>
   <a href="/analysis.html">Analysis</a>
   <a href="/weekly.html">Weekly Payments</a>
   <a href="/borrower_summary.html">Borrower Summary</a>
 </nav>

<h1>Dashboard</h1>
<div class="dashboard-container">
  <div class="dashboard-card">
    <h2>Total Loans</h2>
    <p id="total-loans">LKR 0</p>
  </div>
  <div class="dashboard-card">
    <h2>Total Received</h2>
    <p id="total-received">LKR 0</p>
  </div>
  <div class="dashboard-card">
    <h2>Outstanding</h2>
    <p id="total-outstanding">LKR 0</p>
  </div>
</div>

<div class="section">
   <h2>Recent Loans</h2>
   <div style="margin-bottom: 15px;">
       <button onclick="exportToCSV()" style="background-color: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-right: 10px;">Export to CSV</button>
       <button onclick="exportToJSON()" style="background-color: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">Export to JSON</button>
   </div>
   <table id="loans-table">
    <thead>
      <tr>
        <th>Borrower ID</th>
        <th>Borrower</th>
        <th>Amount</th>
        <th>Interest %</th>
        <th>Weeks</th>
        <th>Paid Weeks</th>
        <th>Remaining Weeks</th>
        <th>Total Paid</th>
        <th>Remaining Amount</th>
        <th>Weekly Installment</th>
        <th>Next Due Date</th>
        <th>Completion Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const API_URL = "";

// Utilities
function formatLKR(amount){
    return "LKR " + parseFloat(amount).toLocaleString("si-LK", {minimumFractionDigits:2, maximumFractionDigits:2});
}

// Load Dashboard
async function loadDashboard(){
    const loansRes = await fetch(`${API_URL}/api/loans`);
    const loans = await loansRes.json();
    const paymentsRes = await fetch(`${API_URL}/api/payments`);
    const payments = await paymentsRes.json();

    let totalLoans = 0;
    let totalReceived = 0;

    loans.forEach(loan => totalLoans += loan.amount * (1 + loan.interest/100));
    payments.forEach(p => totalReceived += p.amount);

    document.getElementById("total-loans").innerText = formatLKR(totalLoans);
    document.getElementById("total-received").innerText = formatLKR(totalReceived);
    document.getElementById("total-outstanding").innerText = formatLKR(totalLoans - totalReceived);
}

// Load Loans Table
async function loadLoans(){
    const res = await fetch(`${API_URL}/api/loans`);
    const loans = await res.json();
    const paymentsRes = await fetch(`${API_URL}/api/payments`);
    const payments = await paymentsRes.json();

    const tbody = document.querySelector("#loans-table tbody");
    tbody.innerHTML = "";

    loans.forEach(loan => {
        const weeklyInstallment = (loan.amount*(1 + loan.interest/100)/loan.weeks).toFixed(2);
        const paidWeeks = payments.filter(p => p.loan_id === loan.id).length;
        const remainingWeeks = loan.weeks - paidWeeks;
        const remainingAmount = (weeklyInstallment * remainingWeeks).toFixed(2);
        const totalPaid = (weeklyInstallment * paidWeeks).toFixed(2);

        // Next due date
        let nextDueDate = "-";
        if(remainingWeeks > 0){
            const nextWeekNumber = paidWeeks + 1;
            const dueDateObj = new Date(loan.start_date);
            dueDateObj.setDate(dueDateObj.getDate() + 7 * nextWeekNumber);
            nextDueDate = dueDateObj.toLocaleDateString("si-LK");
        }

        // Smart weekly installment display
        const isCompleted = paidWeeks === loan.weeks;
        const weeklyDisplay = isCompleted ?
            '<span style="color: #27ae60; font-weight: bold;">0</span>' :
            formatLKR(weeklyInstallment);

        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${loan.borrower_id}</td>
                        <td>${loan.borrower}</td>
                        <td>${formatLKR(loan.amount)}</td>
                        <td>${loan.interest}</td>
                        <td>${loan.weeks}</td>
                        <td>${paidWeeks}</td>
                        <td>${remainingWeeks}</td>
                        <td>${formatLKR(totalPaid)}</td>
                        <td>${formatLKR(remainingAmount)}</td>
                        <td>${weeklyDisplay}</td>
                        <td>${nextDueDate}</td>
                        <td style="font-weight: bold; color: ${isCompleted ? '#27ae60' : '#f39c12'};">${isCompleted ? 'Completed' : 'In Progress'}</td>
                        <td>
                            <button onclick="editLoan(${loan.id}, '${loan.borrower_id}', '${loan.borrower}', ${loan.amount}, ${loan.interest}, ${loan.weeks}, '${loan.start_date}')" style="background-color: #f39c12; margin-right: 5px;">Edit</button>
                            <button onclick="deleteLoan(${loan.id})">Delete</button>
                        </td>`;
        tbody.appendChild(tr);
    });
}

// Edit Loan
function editLoan(id, borrowerId, borrower, amount, interest, weeks, startDate){
    // Create edit modal
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
        z-index: 1000;
    `;

    modal.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 10px; width: 400px; max-width: 90%;">
            <h3>Edit Loan</h3>
            <form id="edit-form">
                <label>Borrower ID:</label>
                <input type="text" id="edit-borrower-id" value="${borrowerId}" required><br><br>

                <label>Borrower Name:</label>
                <input type="text" id="edit-borrower" value="${borrower}" required><br><br>

                <label>Loan Amount:</label>
                <input type="number" id="edit-amount" value="${amount}" required><br><br>

                <label>Interest (%):</label>
                <input type="number" id="edit-interest" value="${interest}" step="0.1" required><br><br>

                <label>Weeks:</label>
                <input type="number" id="edit-weeks" value="${weeks}" required><br><br>

                <label>Start Date:</label>
                <input type="date" id="edit-start-date" value="${startDate}" required><br><br>

                <button type="submit">Update Loan</button>
                <button type="button" onclick="closeModal()" style="background: #95a5a6; margin-left: 10px;">Cancel</button>
            </form>
        </div>
    `;

    document.body.appendChild(modal);

    // Handle form submission
    document.getElementById("edit-form").onsubmit = async function(e){
        e.preventDefault();

        const updatedLoan = {
            borrower_id: document.getElementById("edit-borrower-id").value.trim(),
            borrower: document.getElementById("edit-borrower").value.trim(),
            amount: parseFloat(document.getElementById("edit-amount").value),
            interest: parseFloat(document.getElementById("edit-interest").value),
            weeks: parseInt(document.getElementById("edit-weeks").value),
            start_date: document.getElementById("edit-start-date").value
        };

        try {
            const res = await fetch(`${API_URL}/loans/${id}`, {
                method: "PUT",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(updatedLoan)
            });

            if(!res.ok) throw new Error(await res.text());
            alert("Loan updated successfully!");
            closeModal();
            loadLoans();
            loadDashboard();
        } catch(err) {
            console.error(err);
            alert("Failed to update loan. See console for details.");
        }
    };
}

// Close modal function
function closeModal(){
    const modal = document.querySelector('div[style*="position: fixed"]');
    if(modal) modal.remove();
}

// Delete Loan
async function deleteLoan(loanId){
    if(!confirm("Are you sure you want to delete this loan?")) return;

    try {
        const res = await fetch(`${API_URL}/api/loans/${loanId}`, { method: "DELETE" });
        const data = await res.json();

        if(res.ok){
            alert("Loan deleted successfully!");
            loadLoans();
            loadDashboard();
        } else {
            if(res.status === 400 && data.error === 'Cannot delete loan with ongoing payments'){
                alert(`Cannot delete loan: ${data.details}\n\nYou can delete:\n• New loans (0 payments)\n• Completed loans (all payments made)`);
            } else {
                alert(`Failed to delete loan: ${data.error || 'Unknown error'}`);
            }
        }
    } catch(error) {
        alert("Network error occurred.");
    }
}

// Export to CSV
async function exportToCSV(){
    const loansRes = await fetch(`${API_URL}/api/loans`);
    const loans = await loansRes.json();
    const paymentsRes = await fetch(`${API_URL}/api/payments`);
    const payments = await paymentsRes.json();

    let csvContent = "Borrower ID,Borrower,Amount,Interest %,Weeks,Paid Weeks,Remaining Weeks,Total Paid,Remaining Amount,Weekly Installment,Start Date,Completion Status\n";

    loans.forEach(loan => {
        const weeklyInstallment = (loan.amount*(1 + loan.interest/100)/loan.weeks).toFixed(2);
        const paidWeeks = payments.filter(p => p.loan_id === loan.id).length;
        const remainingWeeks = loan.weeks - paidWeeks;
        const remainingAmount = (weeklyInstallment * remainingWeeks).toFixed(2);
        const totalPaid = (weeklyInstallment * paidWeeks).toFixed(2);
        const completionStatus = paidWeeks === loan.weeks ? "Completed" : "In Progress";

        csvContent += `${loan.borrower_id},"${loan.borrower}",${loan.amount},${loan.interest}%,${loan.weeks},${paidWeeks},${remainingWeeks},${totalPaid},${remainingAmount},${weeklyInstallment},${loan.start_date},${completionStatus}\n`;
    });

    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `loans_export_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

// Export to JSON
async function exportToJSON(){
    const loansRes = await fetch(`${API_URL}/api/loans`);
    const loans = await loansRes.json();
    const paymentsRes = await fetch(`${API_URL}/api/payments`);
    const payments = await paymentsRes.json();

    const exportData = {
        export_date: new Date().toISOString(),
        loans: loans.map(loan => {
            const weeklyInstallment = (loan.amount*(1 + loan.interest/100)/loan.weeks).toFixed(2);
            const paidWeeks = payments.filter(p => p.loan_id === loan.id).length;
            const remainingWeeks = loan.weeks - paidWeeks;
            const remainingAmount = (weeklyInstallment * remainingWeeks).toFixed(2);
            const totalPaid = (weeklyInstallment * paidWeeks).toFixed(2);
            const completionStatus = paidWeeks === loan.weeks ? "Completed" : "In Progress";

            return {
                ...loan,
                weekly_installment: parseFloat(weeklyInstallment),
                paid_weeks: paidWeeks,
                remaining_weeks: remainingWeeks,
                total_paid: parseFloat(totalPaid),
                remaining_amount: parseFloat(remainingAmount),
                completion_status: completionStatus
            };
        }),
        payments: payments,
        summary: {
            total_loans: loans.length,
            total_amount: loans.reduce((sum, loan) => sum + loan.amount, 0),
            total_received: payments.reduce((sum, payment) => sum + payment.amount, 0),
            active_loans: loans.filter(loan => payments.filter(p => p.loan_id === loan.id).length < loan.weeks).length
        }
    };

    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `loans_export_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    window.URL.revokeObjectURL(url);
}

// Call both on load
window.onload = function(){
    loadDashboard();
    loadLoans();
};
</script>
</body>
</html>
