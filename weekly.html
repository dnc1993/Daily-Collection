<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weekly Payments</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f6f8; }
nav { background-color: #2c3e50; padding: 12px 20px; text-align: center; }
nav a { color: #ecf0f1; margin: 0 15px; text-decoration: none; font-weight: bold; font-size: 16px; }
nav a:hover { color: #f39c12; text-decoration: underline; }
h1 { text-align: center; margin-top: 25px; color: #34495e; }

.section { max-width: 1200px; margin: 30px auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
.section h2 { text-align: center; margin-bottom: 15px; }

table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #ddd; }
th { background-color: #3498db; color: white; }
tbody tr:nth-child(even) { background-color: #f9f9f9; }
tbody tr:hover { background-color: #ecf0f1; transition: 0.3s; }

.week-box { padding: 5px; border-radius: 5px; margin: 2px; cursor: pointer; display: inline-block; position: relative; }
.paid { background-color: #2ecc71; color: white; }
.unpaid { background-color: #e74c3c; color: white; }
button { cursor: pointer; background-color: #3498db; color: white; border: none; border-radius: 5px; padding: 3px 6px; margin-top: 3px; }
button:hover { background-color: #2980b9; }
button:disabled { background-color: #95a5a6; cursor: not-allowed; }

/* Loading spinner */
.loading::after {
    content: '';
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s ease-in-out infinite;
    margin-left: 8px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

#check-container { text-align: center; margin-bottom: 20px; }
#check-container input { padding: 6px; font-size: 16px; }
#check-container button { padding: 6px 12px; font-size: 16px; }
</style>
</head>
<body>
<nav>
  <a href="/">Home</a>
   <a href="/newloan.html">New Loan</a>
   <a href="/analysis.html">Analysis</a>
   <a href="/weekly.html">Weekly Payments</a>
   <a href="/borrower_summary.html">Borrower Summary</a>
 </nav>

<h1>Weekly Payments</h1>

<div id="check-container">
  <input type="date" id="check-date">
  <button onclick="checkDueByDate()">Check Due By Date</button>
</div>

<div class="section" id="borrowers-container"></div>

<div class="section">
  <h2>Due Payments</h2>
  <table id="due-table">
    <thead>
      <tr>
        <th>Borrower ID</th>
        <th>Borrower</th>
        <th>Installment Amount</th>
        <th>Due Date</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const API_URL = "";

// Format currency
function formatLKR(amount){
    return "LKR " + parseFloat(amount).toLocaleString("si-LK", {minimumFractionDigits:2, maximumFractionDigits:2});
}

// Load borrowers with weekly boxes
async function loadAllBorrowersHorizontal(){
    const loansRes = await fetch(`${API_URL}/api/loans`);
    const loans = await loansRes.json();
    const paymentsRes = await fetch(`${API_URL}/api/payments`);
    const payments = await paymentsRes.json();

    const container = document.getElementById("borrowers-container");
    container.innerHTML = "";

    loans.forEach(loan => {
        const weeklyInstallment = (loan.amount * (1 + loan.interest/100) / loan.weeks).toFixed(2);
        const borrowerDiv = document.createElement("div");
        borrowerDiv.style.marginBottom = "25px";

        const header = document.createElement("div");
        header.innerHTML = `<strong>Loan ID: ${loan.id} | Borrower: ${loan.borrower} | Borrower ID: ${loan.borrower_id || '-'}</strong>`;
        header.style.marginBottom = "5px";
        borrowerDiv.appendChild(header);

        const weeksDiv = document.createElement("div");
        const startDate = new Date(loan.start_date || new Date());

        for(let i = 1; i <= loan.weeks; i++){
            const paidRecord = payments.find(p => p.loan_id === loan.id && p.week === i);
            const weekDiv = document.createElement("div");
            weekDiv.className = "week-box " + (paidRecord ? "paid" : "unpaid");

            const dueDate = new Date(startDate);
            dueDate.setDate(dueDate.getDate() + 7 * i);
            const formattedDate = dueDate.toLocaleDateString("si-LK");

            weekDiv.innerHTML = `${formattedDate}<br>${formatLKR(weeklyInstallment)}`;

            if(!paidRecord){
                weekDiv.onclick = () => markPaidBackend(loan.id, i, weeklyInstallment);
            } else {
                weekDiv.innerHTML += `<br><button onclick="undoPayment(${paidRecord.id})">Undo</button>`;
            }

            weeksDiv.appendChild(weekDiv);
        }

        borrowerDiv.appendChild(weeksDiv);
        container.appendChild(borrowerDiv);
    });
}

// Global flag to prevent multiple simultaneous payments
let isProcessingPayment = false;

// Update payment UI locally without reloading all data
function updatePaymentUI(loanId, week, status) {
    // Find all borrower containers
    const borrowerContainers = document.querySelectorAll('#borrowers-container > div');

    borrowerContainers.forEach(container => {
        const header = container.querySelector('div');
        const loanIdMatch = header.innerHTML.match(/Loan ID: (\d+)/);

        if (loanIdMatch && parseInt(loanIdMatch[1]) === loanId) {
            // Found the right loan container
            const weekBoxes = container.querySelectorAll('.week-box');

            weekBoxes.forEach((box, index) => {
                // Check if this is the week we want to update (index + 1 because weeks start from 1)
                if (index + 1 === week) {
                    if (status === 'paid') {
                        box.className = 'week-box paid';
                        box.onclick = null;
                        // Add undo button - we'll need to get the payment ID from the response
                        // For now, just mark as paid
                        box.style.pointerEvents = 'none';
                    } else if (status === 'unpaid') {
                        box.className = 'week-box unpaid';
                        box.innerHTML = box.innerHTML.replace(/<br><button.*?<\/button>/, '');
                        box.style.pointerEvents = 'auto';
                        // Re-enable click
                        const amount = box.innerHTML.split('<br>')[1].split('LKR ')[1];
                        box.onclick = () => markPaidBackend(loanId, week, amount);
                    }
                }
            });
        }
    });
}

// Mark payment as paid
async function markPaidBackend(loanId, week, amount){
    // Prevent multiple simultaneous requests
    if(isProcessingPayment){
        return;
    }

    isProcessingPayment = true;

    // Find the clicked week box and disable it
    const weekBoxes = document.querySelectorAll('.week-box');
    let clickedBox = null;
    weekBoxes.forEach(box => {
        if(box.onclick && !box.innerHTML.includes('Processing') && !box.innerHTML.includes('Paid') && box.innerHTML.includes(week)){
            clickedBox = box;
        }
    });

    if(clickedBox){
        clickedBox.style.pointerEvents = 'none';
        clickedBox.style.opacity = '0.6';
        clickedBox.innerHTML = '<span class="loading"></span>Processing...';
    }

    try {
        const paymentData = { loan_id: loanId, week, amount };
        const res = await fetch(`${API_URL}/api/payments`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(paymentData)
        });

        if(res.ok){
            await res.json();
            // Update UI locally instead of reloading everything
            updatePaymentUI(loanId, week, 'paid');
        } else {
            alert("Failed to mark payment.");
            // Re-enable the box if failed
            if(clickedBox){
                clickedBox.style.pointerEvents = 'auto';
                clickedBox.style.opacity = '1';
                // Restore original content
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 7 * week);
                clickedBox.innerHTML = `${dueDate.toLocaleDateString("si-LK")}<br>${formatLKR(amount)}`;
                clickedBox.onclick = () => markPaidBackend(loanId, week, amount);
            }
        }
    } catch(error) {
        alert("Network error occurred.");
        // Re-enable the box if error
        if(clickedBox){
            clickedBox.style.pointerEvents = 'auto';
            clickedBox.style.opacity = '1';
            // Restore original content
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 7 * week);
            clickedBox.innerHTML = `${dueDate.toLocaleDateString("si-LK")}<br>${formatLKR(amount)}`;
            clickedBox.onclick = () => markPaidBackend(loanId, week, amount);
        }
    } finally {
        isProcessingPayment = false;
    }
}

// Global flag to prevent multiple simultaneous undos
let isProcessingUndo = false;

// Undo payment
async function undoPayment(paymentId){
    // Prevent multiple simultaneous requests
    if(isProcessingUndo){
        return;
    }

    isProcessingUndo = true;

    // Find the undo button and disable it
    const undoButtons = document.querySelectorAll('button[onclick*="undoPayment"]');
    let clickedButton = null;
    undoButtons.forEach(btn => {
        if(btn.onclick.toString().includes(paymentId) && !btn.disabled){
            clickedButton = btn;
        }
    });

    if(clickedButton){
        clickedButton.disabled = true;
        clickedButton.innerHTML = '<span class="loading"></span>Processing...';
        clickedButton.style.backgroundColor = '#95a5a6';
    }

    try {
        const res = await fetch(`${API_URL}/api/payments/${paymentId}`, { method: "DELETE" });
        if(res.ok){
            // For undo, we need to reload to get updated payment data
            // This ensures the UI reflects the current database state
            loadAllBorrowersHorizontal();
        } else {
            alert("Failed to undo payment.");
            // Re-enable the button if failed
            if(clickedButton){
                clickedButton.disabled = false;
                clickedButton.innerHTML = 'Undo';
                clickedButton.style.backgroundColor = '#e74c3c';
            }
        }
    } catch(error) {
        alert("Network error occurred.");
        // Re-enable the button if error
        if(clickedButton){
            clickedButton.disabled = false;
            clickedButton.innerHTML = 'Undo';
            clickedButton.style.backgroundColor = '#e74c3c';
        }
    } finally {
        isProcessingUndo = false;
    }
}

// Check due installments by selected date and show total
async function checkDueByDate(){
    const dateInput = document.getElementById("check-date").value;
    if(!dateInput) return alert("Please select a date");
    const targetDate = new Date(dateInput);

    const loansRes = await fetch(`${API_URL}/api/loans`);
    const loans = await loansRes.json();
    const paymentsRes = await fetch(`${API_URL}/api/payments`);
    const payments = await paymentsRes.json();

    const tbody = document.querySelector("#due-table tbody");
    tbody.innerHTML = "";

    let grandTotal = 0;

    loans.forEach(loan => {
        const weeklyAmount = loan.amount * (1 + loan.interest/100) / loan.weeks;
        const paidWeeks = payments.filter(p => p.loan_id === loan.id).length;

        for(let i = paidWeeks + 1; i <= loan.weeks; i++){
            const nextDue = new Date(loan.start_date);
            nextDue.setDate(nextDue.getDate() + 7 * i);

            if(nextDue <= targetDate){
                grandTotal += weeklyAmount;
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${loan.borrower_id || '-'}</td>
                    <td>${loan.borrower}</td>
                    <td>${formatLKR(weeklyAmount)}</td>
                    <td>${nextDue.toLocaleDateString("si-LK")}</td>
                `;
                tbody.appendChild(tr);
            }
        }
    });

    // Add total row
    if(grandTotal > 0){
        const trTotal = document.createElement("tr");
        trTotal.innerHTML = `
            <td colspan="2"><strong>Total</strong></td>
            <td><strong>${formatLKR(grandTotal)}</strong></td>
            <td></td>
        `;
        tbody.appendChild(trTotal);
    }
}

// Load all on page load
window.onload = function(){
    loadAllBorrowersHorizontal();
};
</script>
</body>
</html>
